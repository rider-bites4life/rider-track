<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rider Portal | Bites4Life</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: sans-serif; background: #0f172a; color: white; text-align: center; padding: 20px; }
        .box { background: #1e293b; padding: 30px; border-radius: 20px; max-width: 400px; margin: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        input { width: 100%; padding: 15px; margin-bottom: 20px; border-radius: 10px; border: none; font-size: 18px; text-align: center; box-sizing: border-box; }
        .btn { width: 100%; padding: 25px; margin: 10px 0; border: none; border-radius: 12px; font-size: 20px; font-weight: bold; cursor: pointer; }
        .coming { background: #f59e0b; color: #000; }
        .here { background: #10b981; color: #fff; }
        .stop-btn { background: #ef4444; color: white; display: none; animation: pulse 0.8s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .hidden { display: none; }
        #net-error { background: #ef4444; padding: 10px; border-radius: 8px; margin-bottom: 15px; display: none; }
        .branding { margin-top: 40px; font-size: 10px; color: #475569; letter-spacing: 1px; }
        #welcome-msg { color: #10b981; font-weight: bold; margin-bottom: 15px; display: none; }
    </style>
</head>
<body>
    <div id="net-error">⚠️ No Internet Connection!</div>
    
    <div class="box">
        <h2 style="margin-top:0">Rider Portal</h2>
        
        <div id="welcome-msg"><i class="fas fa-user-circle"></i> Welcome, <span id="r-name"></span></div>

        <div id="setup-section">
            <p>Enter code to activate app</p>
            <input type="text" id="rider-code" placeholder="ENTER CODE">
            <button class="btn here" onclick="registerDevice()">ACTIVATE</button>
        </div>

        <div id="action-section" class="hidden">
            <button id="stop-ring" class="btn stop-btn" onclick="stopRingManual()">
                <i class="fas fa-phone-slash"></i> STOP RINGING
            </button>

            <button class="btn coming" onclick="s('Coming')">COMING</button>
            <button class="btn here" onclick="s('Here')">HERE</button>
            <p id="m" style="color:#f59e0b"></p>
        </div>
    </div>

    <audio id="ring-audio" loop preload="auto">
        <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
    </audio>

    <div class="branding">Powered by <br> <b>HASHIR JUNAID</b></div>

    <script>
        const API = "https://free-martie-hashirpl31-30682c6c.koyeb.app";
        let ringTimeout = null;

        window.onload = function() {
            if(localStorage.getItem('rider_code')) {
                showActions();
                fetchRiderName();
            }
        };

        async function registerDevice() {
            const code = document.getElementById('rider-code').value;
            const res = await fetch(`${API}/check_code/${code}`);
            const data = await res.json();
            if(data.success) {
                localStorage.setItem('rider_code', code);
                showActions();
                fetchRiderName();
            } else alert("Invalid Code!");
        }

        async function fetchRiderName() {
            const code = localStorage.getItem('rider_code');
            const res = await fetch(`${API}/get_riders`);
            const data = await res.json();
            const rider = data.find(r => r.code === code);
            if(rider) {
                document.getElementById('welcome-msg').style.display = 'block';
                document.getElementById('r-name').innerText = rider.name;
            }
        }

        function showActions() {
            document.getElementById('setup-section').classList.add('hidden');
            document.getElementById('action-section').classList.remove('hidden');
            startPolling(); // Call check karne ke liye polling start
        }

        // Polling: Har 3 second baad check karega ke Admin call kar raha hai ya nahi
        function startPolling() {
            setInterval(async () => {
                try {
                    const res = await fetch(`${API}/get_riders`);
                    const data = await res.json();
                    const code = localStorage.getItem('rider_code');
                    const rider = data.find(r => r.code === code);

                    if(rider && rider.ring_status === "ringing") {
                        triggerRing();
                    }
                } catch (e) {}
            }, 3000);
        }

        function triggerRing() {
            const audio = document.getElementById('ring-audio');
            const stopBtn = document.getElementById('stop-ring');
            
            audio.volume = 1.0; // Full volume
            audio.play().catch(e => console.log("User interaction needed for audio"));
            stopBtn.style.display = 'block';

            // 1 Minute (60 sec) timer for No Response
            if(!ringTimeout) {
                ringTimeout = setTimeout(async () => {
                    stopRingInternal();
                    // Status ko "No Response" kar do
                    await s('No Response');
                }, 60000);
            }
        }

        async function stopRingManual() {
            stopRingInternal();
            // Backend ko batayein ke ring rok di gayi hai
            await fetch(`${API}/admin/stop_ring`, {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({code: localStorage.getItem('rider_code')})
            });
        }

        function stopRingInternal() {
            const audio = document.getElementById('ring-audio');
            audio.pause();
            audio.currentTime = 0;
            document.getElementById('stop-ring').style.display = 'none';
            clearTimeout(ringTimeout);
            ringTimeout = null;
        }

        async function s(st) {
            document.getElementById('m').innerText = "Updating...";
            const res = await fetch(`${API}/update_status`, {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({code: localStorage.getItem('rider_code'), status:st})
            });
            if(res.ok) {
                document.getElementById('m').innerText = "Status: " + st;
                document.getElementById('m').style.color = "#10b981";
            } else {
                document.getElementById('m').innerText = "Retry!";
                document.getElementById('m').style.color = "#ef4444";
            }
        }

        setInterval(() => {
            document.getElementById('net-error').style.display = navigator.onLine ? 'none' : 'block';
        }, 2000);
    </script>
</body>
</html>