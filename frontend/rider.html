<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rider Portal | Bites4Life</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: sans-serif; background: #0f172a; color: white; text-align: center; padding: 20px; margin: 0; }
        .box { background: #1e293b; padding: 30px; border-radius: 20px; max-width: 400px; margin: 20px auto; box-shadow: 0 10px 25px rgba(0,0,0,0.3); position: relative; z-index: 1; }
        input { width: 100%; padding: 15px; margin-bottom: 20px; border-radius: 10px; border: none; font-size: 18px; text-align: center; box-sizing: border-box; }
        .btn { width: 100%; padding: 20px; margin: 10px 0; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .coming { background: #f59e0b; color: #000; }
        .here { background: #10b981; color: #fff; }
        .hidden { display: none !important; }
        
        /* Full Screen Alert Overlay */
        #ring-overlay { 
            position: fixed; inset: 0; background: #ef4444; z-index: 10000; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; 
        }
        .blink-bg { animation: blinker 0.6s linear infinite; }
        @keyframes blinker { 50% { opacity: 0.5; } }

        #net-error { background: #ef4444; padding: 10px; border-radius: 8px; margin-bottom: 15px; display: none; }
        .branding { margin-top: 40px; font-size: 10px; color: #475569; letter-spacing: 1px; }
        #welcome-msg { color: #10b981; font-weight: bold; margin-bottom: 15px; display: none; }
    </style>
</head>
<body>
    <div id="net-error">⚠️ No Internet Connection!</div>

    <div id="ring-overlay" class="hidden blink-bg">
        <div style="background:white; padding:30px; border-radius:50%; margin-bottom:20px;">
            <i class="fas fa-bell" style="font-size:70px; color:#ef4444;"></i>
        </div>
        <h1 style="color:white; font-size:35px; text-align:center; font-weight:bold; margin:0;">⚠️ ADMIN CALLING!</h1>
        <p style="color:white; font-size:18px; margin:20px 0;">Urgent attention required on terminal.</p>
        <button class="btn" style="background:white; color:#ef4444; height:80px; font-size:22px; border-radius:20px;" onclick="stopRingManual()">
            STOP RINGING
        </button>
    </div>
    
    <div class="box">
        <h2 style="margin-top:0">Rider Portal</h2>
        <div id="welcome-msg"><i class="fas fa-user-circle"></i> Welcome, <span id="r-name"></span></div>

        <div id="setup-section">
            <p>Enter code to activate app</p>
            <input type="text" id="rider-code" placeholder="ENTER CODE">
            <button class="btn here" onclick="registerDevice()">ACTIVATE</button>
        </div>

        <div id="action-section" class="hidden">
            <button class="btn coming" onclick="s('Coming')">COMING</button>
            <button class="btn here" onclick="s('Here')">HERE</button>
            <p id="m" style="color:#f59e0b; font-weight:bold;"></p>
        </div>
    </div>

    <audio id="ring-audio" loop preload="auto">
        <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
    </audio>

    <div class="branding">Powered by <br> <b>HASHIR JUNAID</b></div>

    <script>
        const API = "https://blind-rivkah-riderpl31-729d2d15.koyeb.app";
        let ringTimeout = null;

        window.onload = function() {
            if(localStorage.getItem('rider_code')) {
                showActions();
                fetchRiderName();
            }
        };

        async function registerDevice() {
            const codeInput = document.getElementById('rider-code');
            const code = codeInput.value;
            
            // Audio init for mobile
            const audio = document.getElementById('ring-audio');
            audio.play().then(() => { audio.pause(); }).catch(e => console.log("Init Audio"));

            try {
                const res = await fetch(`${API}/check_code/${code}`);
                if(res.ok) {
                    localStorage.setItem('rider_code', code);
                    showActions();
                    fetchRiderName();
                } else {
                    alert("Invalid Code!");
                }
            } catch (e) {
                alert("Connection Error!");
            }
        }

        async function fetchRiderName() {
            const code = localStorage.getItem('rider_code');
            try {
                const res = await fetch(`${API}/get_riders`);
                const data = await res.json();
                const rider = data.find(r => r.code === code);
                if(rider) {
                    document.getElementById('welcome-msg').style.display = 'block';
                    document.getElementById('r-name').innerText = rider.name;
                }
            } catch(e) {}
        }

        function showActions() {
            document.getElementById('setup-section').classList.add('hidden');
            document.getElementById('action-section').classList.remove('hidden');
            startPolling();
        }

        function startPolling() {
            setInterval(async () => {
                if (!navigator.onLine) return;
                try {
                    const res = await fetch(`${API}/get_riders`);
                    const data = await res.json();
                    const code = localStorage.getItem('rider_code');
                    const rider = data.find(r => r.code === code);

                    if(rider && rider.ring_status === "ringing") {
                        triggerRing();
                    } else {
                        stopRingInternal();
                    }
                } catch (e) {}
            }, 3500); // Optimized for battery
        }

        function triggerRing() {
            const audio = document.getElementById('ring-audio');
            const overlay = document.getElementById('ring-overlay');
            
            if(audio.paused) {
                overlay.classList.remove('hidden');
                audio.volume = 1.0;
                audio.play().catch(e => console.log("Play blocked"));
            }

            if(!ringTimeout) {
                ringTimeout = setTimeout(async () => {
                    stopRingManual(); // 1 min auto-stop
                    await s('No Response');
                }, 60000);
            }
        }

        async function stopRingManual() {
            stopRingInternal();
            const code = localStorage.getItem('rider_code');
            await fetch(`${API}/admin/stop_ring`, {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({code: code})
            });
        }

        function stopRingInternal() {
            const audio = document.getElementById('ring-audio');
            const overlay = document.getElementById('ring-overlay');
            audio.pause();
            audio.currentTime = 0;
            overlay.classList.add('hidden');
            clearTimeout(ringTimeout);
            ringTimeout = null;
        }

        async function s(st) {
            const msg = document.getElementById('m');
            msg.innerText = "Updating Status...";
            try {
                const res = await fetch(`${API}/update_status`, {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({code: localStorage.getItem('rider_code'), status:st})
                });
                if(res.ok) {
                    msg.innerText = "Status: " + st;
                    msg.style.color = "#10b981";
                }
            } catch (e) {
                msg.innerText = "Sync Error!";
                msg.style.color = "#ef4444";
            }
        }

        setInterval(() => {
            document.getElementById('net-error').style.display = navigator.onLine ? 'none' : 'block';
        }, 3000);
    </script>
</body>
</html>
